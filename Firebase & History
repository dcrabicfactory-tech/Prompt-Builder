import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { 
  Copy, RefreshCw, Check, Sparkles, Zap, ScanEye, Terminal, Wand2, 
  Loader2, Image as ImageIcon, Upload, ArrowDown, MapPin, Aperture, 
  X, Shirt, ChevronDown, Heart, Film, ShoppingBag, Scissors, Smile, 
  Hand, Footprints, MousePointer2, Bot, ImagePlus, Lightbulb, Box, 
  Palette, Eye, EyeOff, Info, HelpCircle, Undo2, Redo2, User, Sun,
  Languages, AlertTriangle, ShieldAlert, BookOpenCheck, Bookmark, Trash2, History,
  Plus, Settings, Save, Edit3, MessageSquareQuote, Link as LinkIcon, Pencil, Layers,
  ChevronUp, Microscope
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, where } from 'firebase/firestore';

// --- FIREBASE INITIALIZATION ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Cấu hình API Key
const apiKey = ""; 

// --- UTILS: IMAGE OPTIMIZATION ---
const resizeImage = (file, maxWidth = 1024) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/jpeg', 0.8));
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });
};

// --- API HELPER ---
const callGeminiApi = async (payload) => {
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return null;
  }
};

// --- HELPER COMPONENTS ---

const GlobalGradientDef = () => (
  <svg width="0" height="0" className="absolute pointer-events-none" aria-hidden="true">
    <defs>
      <linearGradient id="icon-gradient-style" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop stopColor="white" offset="0%" />
        <stop stopColor="#D3A08F" offset="50%" />
        <stop stopColor="rgba(255,255,255,0.6)" offset="100%" />
      </linearGradient>
      <linearGradient id="icon-gradient-active" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop stopColor="#FE9C00" offset="0%" />
        <stop stopColor="#D3A08F" offset="100%" />
      </linearGradient>
    </defs>
  </svg>
);

const ICON_MAP = {
  Heart, ScanEye, Zap, Film, Palette, Scissors, Shirt, User, MapPin, ShoppingBag, 
  Smile, Hand, Footprints, Aperture, ImagePlus, Star: Sparkles, Box, Ghost: Bot,
  Settings, BookOpenCheck, Bookmark, Bot, Sparkles, Image: ImageIcon, ImageIcon, Wand2, Terminal
};

const GradientIcon = React.memo(({ icon, iconName, size = 22, className = "", gradientId = "icon-gradient-style" }) => {
  const getIconComp = () => {
    if (typeof icon === 'function') return icon;
    if (icon && typeof icon === 'object' && icon.$$typeof) return icon; 
    const key = iconName || (typeof icon === 'string' ? icon : null);
    if (key && ICON_MAP[key]) return ICON_MAP[key];
    return Sparkles;
  };

  const IconComp = getIconComp();
  if (typeof IconComp !== 'function' && (typeof IconComp !== 'object' || !IconComp.$$typeof)) {
    return null;
  }

  return (
    <div className={`relative flex items-center justify-center ${className}`}>
      <IconComp size={size} style={{ stroke: `url(#${gradientId})` }} />
    </div>
  );
});

const BackgroundLiquid = React.memo(() => (
  <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none bg-[#0a0504]">
    <div className="absolute top-[-10%] left-[-10%] w-[90%] h-[90%] opacity-40" style={{ background: 'radial-gradient(circle, rgba(43,43,43,0.8) 0%, rgba(10,5,4,0) 70%)' }} />
    <div className="absolute bottom-[-10%] right-[-10%] w-[80%] h-[80%] opacity-30" style={{ background: 'radial-gradient(circle, rgba(143,141,141,0.4) 0%, rgba(10,5,4,0) 70%)' }} />
    <div className="absolute top-[30%] right-[-5%] w-[50%] h-[50%] opacity-20" style={{ background: 'radial-gradient(circle, rgba(211,160,143,0.3) 0%, rgba(10,5,4,0) 70%)' }} />
  </div>
));

const ConfirmButton = React.memo(({ isConfirmed, onConfirm, onCancel, isDisabled, isEmptyButConfirmed }) => {
    if (isEmptyButConfirmed) {
        return (
            <button 
                onClick={onConfirm} 
                className="flex-1 py-3 px-3 flex items-center justify-center gap-2 text-sm font-black uppercase rounded-[1.2rem] transition-all bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/30"
            >
                <Trash2 size={16} /> <span>Xóa thiết lập</span>
            </button>
        );
    }
    
    return (
        <div className="flex gap-3 w-full">
            <button 
                onClick={onConfirm} 
                disabled={isDisabled} 
                className={`flex-1 py-3 px-3 md:px-5 flex items-center justify-center gap-2 md:gap-3 text-sm md:text-base font-black uppercase rounded-[1.2rem] transition-all duration-300 transform active:scale-95 whitespace-nowrap ${isConfirmed ? 'bg-[#FE9C00] text-white shadow-lg shadow-[#FE9C00]/40 ring-1 ring-white/30' : isDisabled ? 'bg-white/5 text-slate-600 cursor-not-allowed border border-white/5' : 'bg-[#FE9C00] text-white shadow-xl shadow-[#FE9C00]/20'}`}
            >
                <ArrowDown size={16} className={`md:w-[18px] md:h-[18px] ${isDisabled ? "text-[#8F8D8D]" : "text-white"} ${isConfirmed ? "animate-bounce" : ""}`} /> 
                <span className={isDisabled ? "text-[#8F8D8D]" : "text-white"}>{isConfirmed ? "Xác nhận" : "Áp dụng"}</span>
            </button>
            {isConfirmed && <button onClick={onCancel} className="w-[48px] h-[48px] md:w-[50px] md:h-[50px] flex items-center justify-center bg-red-500/20 hover:bg-red-500/40 text-red-200 rounded-full border border-red-500/20 backdrop-blur-3xl transition-all"><X size={18} className="md:w-[20px] md:h-[20px]" /></button>}
        </div>
    );
});

const ModeToggle = React.memo(({ isProduct, onToggle }) => (
  <div className="flex-1 flex bg-white/5 p-1 rounded-2xl border border-white/10 relative">
    <div className={`absolute inset-y-1 w-[calc(50%-4px)] bg-[#FE9C00] rounded-xl shadow-lg shadow-[#FE9C00]/20 transition-all duration-300 ease-out ${isProduct ? 'left-[calc(50%+2px)]' : 'left-1'}`} />
    <button onClick={() => onToggle(false)} className={`relative flex-1 py-3 text-sm font-black uppercase tracking-wider transition-colors z-10 flex items-center justify-center gap-2 ${!isProduct ? 'text-white' : 'text-white/40 hover:text-white/60'}`}><Sparkles size={14} className={!isProduct ? 'opacity-100' : 'opacity-0 hidden'} />Model</button>
    <button onClick={() => onToggle(true)} className={`relative flex-1 py-3 text-sm font-black uppercase tracking-wider transition-colors z-10 flex items-center justify-center gap-2 ${isProduct ? 'text-white' : 'text-white/40 hover:text-white/60'}`}><Box size={14} className={isProduct ? 'opacity-100' : 'opacity-0 hidden'} />Product</button>
  </div>
));

const PromptSourceControl = React.memo(({ onSelectAI, onSelectManual, onSelectImageUpload, hasAiData, hasSelection, activeSource, undo, redo, canUndo, canRedo }) => {
  const getButtonClass = (isActive, isDisabled, activeBg) => `
    flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-all duration-300
    ${isActive ? `${activeBg} text-white shadow-lg` : isDisabled ? 'text-[#8F8D8D]/50 cursor-not-allowed' : 'text-[#8F8D8D] hover:text-white hover:bg-white/5'}
  `;
  return (
    <div className="flex items-center justify-between w-full mb-2">
      <div className="flex items-center gap-1 bg-black/20 p-1 rounded-lg border border-white/5 w-fit transition-all">
        <button onClick={onSelectAI} disabled={!hasAiData} className={getButtonClass(activeSource === 'ai', !hasAiData, 'bg-[#FE9C00]')} title="AI Scan">
          <Bot size={14} /><span className={`${activeSource === 'ai' ? 'max-w-[100px] opacity-100 ml-1' : 'max-w-0 opacity-0 ml-0'} overflow-hidden whitespace-nowrap transition-all duration-300 ease-in-out`}>AI Scan</span>
        </button>
        <button onClick={onSelectManual} className={getButtonClass(activeSource === 'manual', false, 'bg-[#8F8D8D]/40')} title="Lựa chọn">
          <MousePointer2 size={14} /><span className={`${activeSource === 'manual' ? 'max-w-[100px] opacity-100 ml-1' : 'max-w-0 opacity-0 ml-0'} overflow-hidden whitespace-nowrap transition-all duration-300 ease-in-out`}>Lựa chọn</span>
        </button>
        {onSelectImageUpload && (
          <button onClick={onSelectImageUpload} className={getButtonClass(activeSource === 'image_scan', false, 'bg-[#FE9C00]')} title="Scan Ảnh">
            <ImagePlus size={14} /><span className={`${activeSource === 'image_scan' ? 'max-w-[100px] opacity-100 ml-1' : 'max-w-0 opacity-0 ml-0'} overflow-hidden whitespace-nowrap transition-all duration-300 ease-in-out`}>Scan Ảnh</span>
          </button>
        )}
      </div>
      <div className="flex items-center gap-1 bg-black/20 p-1 rounded-lg border border-white/5">
         <button onClick={undo} disabled={!canUndo} className={`p-1.5 rounded-md transition-colors ${!canUndo ? 'text-[#8F8D8D]/30 cursor-not-allowed' : 'text-[#8F8D8D] hover:text-white hover:bg-white/10'}`} title="Hoàn tác">
            <Undo2 size={14} />
         </button>
         <button onClick={redo} disabled={!canRedo} className={`p-1.5 rounded-md transition-colors ${!canRedo ? 'text-[#8F8D8D]/30 cursor-not-allowed' : 'text-[#8F8D8D] hover:text-white hover:bg-white/10'}`} title="Làm lại">
            <Redo2 size={14} />
         </button>
      </div>
    </div>
  );
});

const SuggestionPills = React.memo(({ suggestions, onSelect, currentValue, onClear }) => {
    if (!suggestions || suggestions.length === 0) return null;
    return (
        <div className="flex flex-wrap items-center gap-2 mb-3 animate-in fade-in slide-in-from-top-1 duration-300">
            {suggestions.map((item, index) => {
                const isActive = currentValue && currentValue === item.value_en;
                return (
                    <button
                        key={index}
                        onClick={() => onSelect(String(item.value_en || ''))}
                        className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all duration-200 active:scale-95 whitespace-nowrap ${isActive ? 'bg-[#FE9C00] text-white border-[#FE9C00] shadow-md shadow-[#FE9C00]/20' : 'bg-white/5 text-[#D3A08F] border-white/10 hover:bg-[#FE9C00] hover:text-white hover:shadow-lg hover:shadow-[#FE9C00]/20'}`}
                        title={String(item.value_en || '')}
                    >
                        {String(item.label_vi || '')}
                    </button>
                )
            })}
            <button 
                onClick={onClear}
                className="w-6 h-6 rounded-full flex items-center justify-center bg-white/5 text-[#8F8D8D] hover:bg-red-500/20 hover:text-red-400 hover:border-red-500/30 border border-white/10 transition-all ml-1"
                title="Xóa prompt"
            >
                <X size={12} />
            </button>
        </div>
    );
});

const ExplanationBox = ({ text, isLoading, onTranslate }) => {
   if (!text && !onTranslate) return null;
   const displayValue = String(text || '');
   return (
      <div className="mt-2 mb-2 text-[11px] md:text-xs text-white/70 italic border-l-2 border-[#FE9C00]/50 pl-2 flex flex-row items-center justify-between gap-2 animate-in fade-in slide-in-from-left-2">
         <span className="flex-1 line-clamp-2 md:line-clamp-none">{displayValue || (isLoading ? "..." : "")}</span>
         {(!displayValue && onTranslate) && (
            <button onClick={onTranslate} disabled={isLoading} className="flex items-center gap-1 px-2.5 py-1.5 md:px-3 md:py-1 bg-white/10 hover:bg-[#FE9C00]/20 rounded-full text-[10px] font-bold text-[#FE9C00] transition-all whitespace-nowrap border border-white/5 flex-shrink-0">
                {isLoading ? <Loader2 size={10} className="animate-spin" /> : <Languages size={10} />}
                <span className="hidden xs:inline ml-0.5">Dịch</span><span className="hidden sm:inline"> & Giải thích</span>
            </button>
         )}
      </div>
   );
};

// --- NEW COMPONENT: WorkflowItem to fix Hooks error ---
const WorkflowItem = React.memo(({ 
    f, 
    customFields, 
    setCustomFields, 
    aiData, 
    explanations, 
    suggestionLoading, 
    fieldSuggestions, 
    handleImageUpload, 
    analyzeSpecific, 
    handleExplain, 
    handleAiSuggestions,
    titleGradientClass
}) => {
    const isCustom = f.isCustom;
    
    // Define handlers specific to this item
    const handleCustomChange = useCallback((val) => {
        setCustomFields(prev => ({
            ...prev,
            [f.id]: { ...prev[f.id], state: val }
        }));
    }, [f.id, setCustomFields]);

    const handleCustomConfirm = useCallback((val) => {
        setCustomFields(prev => ({
            ...prev,
            [f.id]: { ...prev[f.id], confirmed: val }
        }));
    }, [f.id, setCustomFields]);

    const customVal = customFields[f.id]?.state || "";
    const customConf = customFields[f.id]?.confirmed || "";
    
    const activeVal = isCustom ? customVal : f.state.state;
    const activeConf = isCustom ? customConf : f.conf;
    const activeSetState = isCustom ? handleCustomChange : f.state.set;
    const activeSetConf = isCustom ? handleCustomConfirm : f.setConf;

    // This useEffect is now safe inside the component
    useEffect(() => {
        if (isCustom && f.selection && !customVal) {
            handleCustomChange(f.selection);
        }
    }, [isCustom, f.selection, customVal, handleCustomChange]);

    return (
        <div className={`p-5 rounded-[1.8rem] border transition-all ${activeConf ? 'bg-[#FE9C00]/10 border-[#FE9C00]/50' : 'bg-white/[0.02] border-white/10'}`}>
           <label className="text-sm font-black flex items-center gap-3 uppercase mb-2"><GradientIcon icon={f.icon} size={22} /><span className={titleGradientClass}>{String(f.label || '')}</span></label>
           
           {!isCustom && (
                <PromptSourceControl 
                    activeSource={f.showUpload ? 'image_scan' : (f.state.state === aiData[f.id] ? 'ai' : 'manual')} 
                    hasAiData={!!aiData[f.id]} hasSelection={!!f.selection}
                    onSelectAI={() => { if(f.setShowUpload) f.setShowUpload(false); f.state.set(String(aiData[f.id] || "")); }} 
                    onSelectManual={() => { if(f.setShowUpload) f.setShowUpload(false); f.state.set(String(f.selection || "")); }} 
                    onSelectImageUpload={f.setShowUpload ? () => f.setShowUpload(true) : undefined}
                    undo={f.state.undo} redo={f.state.redo} canUndo={f.state.canUndo} canRedo={f.state.canRedo} 
                />
           )}
           
           {f.showUpload ? (
                <div className="flex flex-col gap-3 mb-2 animate-in fade-in zoom-in-95 duration-300">
                    {f.uploadImg ? (
                        <div className="relative w-full h-32 rounded-xl overflow-hidden ring-1 ring-white/10"><img src={f.uploadImg} className="w-full h-full object-cover" /><button onClick={() => { f.setUpload(null); f.setBase64(null); f.state.set(""); }} className="absolute top-2 right-2 bg-black/60 p-1 rounded-full"><X size={14} /></button></div>
                    ) : ( <div onClick={() => f.ref.current?.click()} className="w-full h-32 border-2 border-dashed border-white/10 rounded-xl bg-black/20 flex flex-col items-center justify-center cursor-pointer"><ImagePlus size={24} className="text-slate-400 mb-1" /><span className="text-[10px] text-slate-400 font-bold uppercase">Upload mẫu</span></div> )}
                    <input type="file" ref={f.ref} onChange={(e) => handleImageUpload(e, f.setUpload, f.setBase64)} accept="image/*" className="hidden" />
                    
                    <textarea value={activeVal} onChange={(e) => activeSetState(e.target.value)} placeholder="Kết quả phân tích..." className="w-full h-24 bg-black/30 border border-white/10 rounded-xl p-3 text-sm text-white font-bold outline-none resize-none mb-1" />

                    <ExplanationBox text={explanations[f.explKey]} isLoading={suggestionLoading === f.explKey + '_explain'} onTranslate={() => handleExplain(f.explKey, activeVal)} />
                    
                    <button 
                        onClick={() => f.uploadBase64 && analyzeSpecific(f.uploadBase64, f.promptSuffix, (val) => { f.state.set(val); setAiData(prev => ({...prev, [f.key]: val})); }, f.setAnalyzing, f.id)} 
                        disabled={!f.uploadBase64 || f.analyzing} 
                        className={`w-full py-3 bg-[#FE9C00] text-white shadow-xl shadow-[#FE9C00]/20 rounded-[1.2rem] font-black text-sm uppercase flex items-center justify-center gap-2 active:scale-95 transition-all disabled:opacity-50 ring-1 ring-white/20`}
                    >
                        {f.analyzing ? <Loader2 size={16} className="animate-spin" /> : <ScanEye size={16} />} 
                        <span>{f.analyzing ? "Đang xử lý..." : `Phân tích ${String(f.label).replace(/^\d+\.\s*/, '')}`}</span>
                    </button>

                    <div className="flex gap-2 w-full mt-2">
                        <ConfirmButton 
                            isConfirmed={activeConf === activeVal && !!activeVal} 
                            isEmptyButConfirmed={!!activeConf && !activeVal}
                            isDisabled={!activeVal && !activeConf} 
                            onConfirm={() => activeSetConf(activeVal)} 
                            onCancel={() => activeSetConf("")} 
                        />
                    </div>
                </div>
           ) : (
                <>
                    <textarea value={activeVal} onChange={(e) => activeSetState(e.target.value)} placeholder="..." className="w-full h-24 bg-transparent text-white font-bold outline-none resize-none mb-2 placeholder:text-white/10" />
                    
                    {!isCustom && <ExplanationBox text={explanations[f.explKey]} isLoading={suggestionLoading === f.explKey + '_explain'} onTranslate={() => handleExplain(f.explKey, activeVal)} />}
                    <SuggestionPills suggestions={fieldSuggestions[f.id]} onSelect={activeSetState} currentValue={activeVal} onClear={() => activeSetState("")} />
                    
                    <div className="flex gap-2 w-full mt-2">
                        <ConfirmButton 
                            isConfirmed={activeConf === activeVal && !!activeVal} 
                            isEmptyButConfirmed={!!activeConf && !activeVal}
                            isDisabled={!activeVal && !activeConf} 
                            onConfirm={() => activeSetConf(activeVal)} 
                            onCancel={() => activeSetConf("")} 
                        />
                    </div>
                </>
           )}
        </div>
    );
});

const EditOptionModal = ({ isOpen, onClose, optionData, onSave, isProcessing }) => {
    const [label, setLabel] = useState("");
    const [subLabel, setSubLabel] = useState("");
    const [value, setValue] = useState("");
    const [detailVi, setDetailVi] = useState("");
    const [img, setImg] = useState("");

    useEffect(() => {
        if (optionData) {
            setLabel(optionData.label || "");
            setSubLabel(optionData.subLabel || "");
            setValue(optionData.value || "");
            setDetailVi(optionData.detail_vi || "");
            setImg(optionData.img || "");
        }
    }, [optionData]);

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-300">
            <div className="bg-[#1a1514] border border-[#FE9C00]/30 rounded-[2rem] p-6 w-full max-w-md shadow-2xl animate-in zoom-in-95 duration-300 relative overflow-hidden flex flex-col max-h-[90vh]">
                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#FE9C00] to-transparent opacity-50"></div>
                
                <h3 className="text-lg font-black text-white uppercase mb-4 flex items-center gap-2">
                    <div className="p-2 bg-[#FE9C00]/20 rounded-lg"><Edit3 size={18} className="text-[#FE9C00]" /></div>
                    Chỉnh sửa Lựa chọn
                </h3>
                
                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2">
                    <div>
                         <label className="text-[10px] font-bold text-white/40 uppercase block mb-1">Tiêu đề (Label)</label>
                         <input value={label} onChange={e => setLabel(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-[#FE9C00]" />
                    </div>
                    <div>
                         <label className="text-[10px] font-bold text-white/40 uppercase block mb-1">Phụ đề (SubLabel)</label>
                         <input value={subLabel} onChange={e => setSubLabel(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-[#FE9C00]" />
                    </div>
                    <div>
                         <label className="text-[10px] font-bold text-white/40 uppercase block mb-1">Link Ảnh (Image URL)</label>
                         <div className="flex gap-2">
                            <input value={img} onChange={e => setImg(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-[#FE9C00]" />
                            {img && <img src={img} className="w-10 h-10 rounded-lg object-cover border border-white/10" alt="Preview" onError={(e) => e.target.style.display='none'} />}
                         </div>
                    </div>
                    <div>
                         <label className="text-[10px] font-bold text-white/40 uppercase block mb-1 flex items-center gap-2">Prompt Value <Sparkles size={10} className="text-[#FE9C00]" /> (AI sẽ tinh chỉnh khi lưu)</label>
                         <textarea value={value} onChange={e => setValue(e.target.value)} className="w-full h-24 bg-white/5 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-[#FE9C00] resize-none" />
                    </div>
                    <div>
                         <label className="text-[10px] font-bold text-white/40 uppercase block mb-1">Diễn giải Tiếng Việt</label>
                         <textarea value={detailVi} onChange={e => setDetailVi(e.target.value)} className="w-full h-16 bg-white/5 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-[#FE9C00] resize-none" />
                    </div>
                </div>

                <div className="flex gap-3 mt-4 pt-4 border-t border-white/5">
                    <button onClick={onClose} disabled={isProcessing} className="flex-1 py-3 bg-white/5 rounded-xl text-white/60 font-bold hover:bg-white/10 transition-colors">Hủy</button>
                    <button onClick={() => onSave({ ...optionData, label, subLabel, value, detail_vi: detailVi, img })} disabled={isProcessing} className="flex-1 py-3 bg-[#FE9C00] rounded-xl text-white font-bold flex items-center justify-center gap-2 hover:bg-[#FE9C00]/80 transition-all shadow-lg shadow-[#FE9C00]/20">
                        {isProcessing ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />} Lưu thay đổi
                    </button>
                </div>
            </div>
        </div>
    );
};

const CustomCreatorModal = ({ isOpen, onClose, type, parentCategory, onSave }) => {
    const [input, setInput] = useState("");
    const [loading, setLoading] = useState(false);
    const [targetField, setTargetField] = useState("subject");

    const handleCreate = async () => {
        if (!input.trim()) return;
        setLoading(true);
        const prompt = type === 'category' 
            ? `Create JSON for prompt CATEGORY: "${input}". Keys: {"id":"slug", "title":"Short Title", "icon":"(Choose ONE name from: Heart, ScanEye, Zap, Film, Palette, Scissors, Shirt, User, MapPin, Box, Settings, BookOpenCheck)", "description":"Vietnamese desc"}`
            : `Create JSON for prompt OPTION in "${parentCategory}": "${input}". Keys: {"id":"slug", "label":"Short Label", "subLabel":"English style", "value":"Detailed English prompt", "detail_vi": "Vietnamese explanation", "img":"https://source.unsplash.com/random/200x120/?${input}"}`;
        
        try {
            const res = await callGeminiApi({ contents: [{ parts: [{ text: prompt }] }] });
            let data = {};
            try {
                data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
            } catch (e) { console.error("Parse Error", e); }

            if (type === 'category') {
                data.targetField = String(targetField);
                if (typeof data.icon !== 'string') data.icon = 'Sparkles';
            }
            onSave(data);
            setInput(""); onClose();
        } catch (e) { console.error(e); }
        setLoading(false);
    };

    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-300">
            <div className="bg-[#1a1514] border border-[#FE9C00]/30 rounded-[2rem] p-6 w-full max-w-md shadow-2xl animate-in zoom-in-95 duration-300 relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#FE9C00] to-transparent opacity-50"></div>
                
                <h3 className="text-lg font-black text-white uppercase mb-4 flex items-center gap-2">
                    <div className="p-2 bg-[#FE9C00]/20 rounded-lg"><Sparkles size={18} className="text-[#FE9C00]" /></div>
                    {type === 'category' ? "Thêm Danh mục" : `Thêm vào ${String(parentCategory || '')}`}
                </h3>
                
                <input value={input} onChange={e => setInput(e.target.value)} placeholder={type === 'category' ? "Tên danh mục (VD: Vũ khí, Xe cộ...)" : "Tên lựa chọn (VD: Kiếm Katana, Xe Ferrari...)"} className="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white outline-none mb-4 focus:border-[#FE9C00] transition-colors placeholder:text-white/20" autoFocus />
                
                {type === 'category' && (
                    <div className="mb-4">
                        <label className="text-[10px] font-bold text-white/40 uppercase mb-2 block">Liên kết vào ô nhập liệu:</label>
                        <select value={targetField} onChange={e => setTargetField(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-sm text-white outline-none">
                            <option value="subject">1. Chủ thể</option>
                            <option value="tech">2. Camera & Lens</option>
                            <option value="lighting">3. Ánh sáng</option>
                            <option value="makeup">4. Trang điểm</option>
                            <option value="hair">5. Tóc</option>
                            <option value="outfit">6. Phục trang</option>
                            <option value="pose">7. Dáng & Cử chỉ</option>
                            <option value="bg">8. Bối cảnh</option>
                        </select>
                    </div>
                )}

                <div className="flex gap-3">
                    <button onClick={onClose} className="flex-1 py-3 bg-white/5 rounded-xl text-white/60 font-bold hover:bg-white/10 transition-colors">Hủy</button>
                    <button onClick={handleCreate} disabled={loading} className="flex-1 py-3 bg-[#FE9C00] rounded-xl text-white font-bold flex items-center justify-center gap-2 hover:bg-[#FE9C00]/80 transition-all shadow-lg shadow-[#FE9C00]/20">
                        {loading ? <Loader2 size={18} className="animate-spin" /> : <Wand2 size={18} />} AI Tạo & Thêm
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- CUSTOM HOOK: UNDO/REDO ---
const useUndoRedo = (initialState) => {
  const [past, setPast] = useState([]);
  const [present, setPresent] = useState(initialState);
  const [future, setFuture] = useState([]);
  
  const set = (newPresent) => {
    if (newPresent === present) return;
    setPast((prev) => [...prev, present]);
    setPresent(newPresent);
    setFuture([]);
  };
  const undo = () => { if(past.length>0) { const prev=past[past.length-1]; setFuture([present,...future]); setPresent(prev); setPast(past.slice(0,-1)); } };
  const redo = () => { if(future.length>0) { const next=future[0]; setPast([...past,present]); setPresent(next); setFuture(future.slice(1)); } };
  const reset = (val) => { setPresent(val); setPast([]); setFuture([]); };
  return { state: present, set, undo, redo, canUndo: past.length > 0, canRedo: future.length > 0, reset };
};

// --- STATIC DATA ---
const PROMPT_DATA = {
  camera_setup: {
    title: "Góc máy & Cảm xúc",
    icon: Heart,
    description: "Vị trí máy quay và bố cục khung hình",
    options: [
      { id: 'high_angle', label: 'High Angle', subLabel: 'máy quay cao hơn chủ thể', value: 'high angle shot, looking down at the subject, overhead perspective', img: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&q=80&w=200&h=120', recommended: ['full_body', 'medium_shot'], detail_vi: 'Góc máy từ trên cao giúp chủ thể trông nhỏ bé hơn, tạo cảm giác bị bao vây hoặc dễ bị tổn thương.' },
      { id: 'low_angle', label: 'Low Angle', subLabel: 'máy quay thấp hơn chủ thể', value: 'low angle shot, looking up at the subject, heroic perspective, dominant presence', img: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&q=80&w=200&h=120', recommended: ['full_body', 'portrait'], detail_vi: 'Góc máy từ dưới lên khiến chủ thể trông cao lớn, uy quyền và mạnh mẽ hơn.' },
      { id: 'eye_level', label: 'Eye-level shot', subLabel: 'ngang tầm mắt, trung tính', value: 'eye-level shot, neutral perspective, natural gaze, straight on portrait', img: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&q=80&w=200&h=120', recommended: ['portrait', 'medium_shot'], detail_vi: 'Góc nhìn ngang tầm mắt tạo cảm giác tự nhiên, gần gũi.' },
      { id: 'front_view', label: 'Front view', subLabel: 'máy quay đối diện chủ thể', value: 'front view, facing the subject directly, symmetrical headshot', img: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?auto=format&fit=crop&q=80&w=200&h=120', recommended: ['portrait', 'medium_shot'], detail_vi: 'Góc nhìn trực diện giúp tối ưu hóa sự đối xứng và tạo kết nối mạnh mẽ.' },
      { id: 'centered', label: 'Centered composition', subLabel: 'chủ thể nằm giữa khung hình', value: 'centered composition, subject in middle of frame, balanced photography', img: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&q=80&w=200&h=120', recommended: ['portrait', 'medium_shot', 'full_body'], detail_vi: 'Bố cục trung tâm đặt chủ thể ngay giữa ảnh, tạo sự tập trung tuyệt đối.' },
      { id: 'side_view', label: 'Side view / Profile', subLabel: 'nhìn ngang 90°', value: 'side view, profile shot, 90 degree angle, highlighting silhouette and facial contour', img: 'https://images.unsplash.com/photo-1503104834685-7205e8607eb9?auto=format&fit=crop&q=80&w=200&h=120', recommended: ['portrait', 'medium_shot'], detail_vi: 'Chụp góc nghiêng 90 độ làm nổi bật đường nét khuôn mặt.' },
    ]
  },
  camera: {
    title: "Ống kính & Tiêu cự",
    icon: ScanEye,
    description: "Phạm vi khung hình và độ xóa phông",
    options: [
      { id: 'full_body', label: 'Toàn thân', subLabel: 'Wide 24mm', value: 'full body shot, wide angle view, environment context', img: 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Góc rộng 24mm giúp lấy trọn vóc dáng và bối cảnh xung quanh.' },
      { id: 'portrait', label: 'Chân dung', subLabel: 'Tele 85mm', value: 'portrait shot, 85mm lens, creamy bokeh background', img: 'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?auto=format&fit=crop&q=80&w=300&h=120', detail_vi: 'Tiêu cự 85mm giúp khuôn mặt không bị biến dạng và xóa phông đẹp.' },
      { id: 'medium_shot', label: 'Nửa người', subLabel: '50mm Lens', value: 'medium shot, waist up, 50mm lens, standard photography', img: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Tiêu cự 50mm tương đương mắt người, mang lại cảm giác chân thực.' },
    ]
  },
  makeup: {
    title: "Make-up & Khuôn mặt",
    icon: Palette,
    description: "Phong cách trang điểm",
    options: [
      { id: 'natural', label: 'Tự nhiên', subLabel: 'No-makeup', value: 'natural makeup, soft skin texture', img: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Phong cách trang điểm tự nhiên.' },
      { id: 'cyberpunk', label: 'Cyberpunk', subLabel: 'Neon', value: 'cyberpunk makeup, neon accents', img: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Trang điểm neon rực rỡ phong cách tương lai.' },
    ]
  },
  hair: {
    title: "Kiểu Tóc",
    icon: Scissors,
    description: "Phong cách tóc",
    options: [
      { id: 'long_straight', label: 'Dài thẳng', subLabel: 'Elegant', value: 'long straight hair', img: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Tóc dài thẳng mượt mà.' },
      { id: 'curly', label: 'Tóc Xoăn', subLabel: 'Voluminous', value: 'voluminous curly hair', img: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Tóc xoăn bồng bềnh cá tính.' },
    ]
  },
  pose_head: {
    title: "Pose: Đầu & Mặt",
    icon: Smile,
    description: "Hướng nhìn và biểu cảm",
    options: [
      { id: 'look_cam', label: 'Nhìn Cam', subLabel: 'Direct', value: 'looking directly at camera', img: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Mắt nhìn thẳng vào ống kính.' },
    ]
  },
  pose_hands: {
    title: "Pose: Tay",
    icon: Hand,
    description: "Vị trí tay",
    options: [
      { id: 'pockets', label: 'Tay túi quần', subLabel: 'Casual', value: 'hands in pockets', img: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Tay cho vào túi quần thư giãn.' },
    ]
  },
  pose_legs: {
    title: "Pose: Chân & Dáng",
    icon: Footprints,
    description: "Tư thế đứng ngồi",
    options: [
      { id: 'standing', label: 'Đứng thẳng', subLabel: 'Basic', value: 'standing tall', img: 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Đứng thẳng cơ bản.' },
    ]
  },
  accessories: {
    title: "Vật phẩm & Phụ kiện",
    icon: ShoppingBag,
    description: "Đồ vật cầm tay",
    options: [
      { id: 'bag', label: 'Túi xách', subLabel: 'Fashion', value: 'holding a luxury handbag', img: 'https://images.unsplash.com/photo-1584917865442-de89df76afd3?auto=format&fit=crop&q=80&w=200&h=120' },
    ]
  },
  technical: {
    title: "Chất ảnh & Film",
    icon: Film,
    description: "Chất liệu ảnh và thiết bị mô phỏng",
    options: [
      { id: 'fuji', label: 'Fujifilm', subLabel: 'Vintage', value: 'shot on Fujifilm, vintage film grain', img: 'https://images.unsplash.com/photo-1526285849717-482456cd7436?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Mô phỏng màu sắc cổ điển và độ hạt phim đặc trưng.' },
      { id: 'leica', label: 'Leica Look', subLabel: 'Sắc nét', value: 'shot on Leica M11, sharp optics', img: 'https://images.unsplash.com/photo-1510127034890-ba27508e9f1c?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Độ tương phản cao và màu sắc thực tế từ ống kính huyền thoại.' },
    ]
  },
  lighting: {
    title: "Ánh sáng",
    icon: Zap,
    description: "Thiết lập mood ánh sáng",
    options: [
      { id: 'golden_hour', label: 'Golden Hour', subLabel: 'Natural orange glow', value: 'warm golden hour sunlight', img: 'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Ánh nắng ấm áp của buổi chiều tà, tạo vẻ lãng mạn.' },
      { id: 'side_soft', label: 'Side + Soft', subLabel: 'Dimensional portrait', value: 'side lighting, soft light', img: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&q=80&w=200&h=120', detail_vi: 'Tạo các mảng sáng tối nhẹ nhàng, làm khuôn mặt có chiều sâu.' },
    ]
  }
};

const CATEGORY_ORDER = ['camera_setup', 'camera', 'makeup', 'hair', 'pose_head', 'pose_hands', 'pose_legs', 'accessories', 'technical', 'lighting'];

// --- MAIN APP COMPONENT ---

export default function App() {
  const [selections, setSelections] = useState({});
  const [activeCategory, setActiveCategory] = useState(""); 
  const [isProductMode, setIsProductMode] = useState(false);
  const [isGlobalEditMode, setIsGlobalEditMode] = useState(false); // Global Edit Mode
  const [isHistoryExpanded, setIsHistoryExpanded] = useState(true); // Toggle History
  
  const [expandedOptionIds, setExpandedOptionIds] = useState(new Set());
  const [expandedDetailIds, setExpandedDetailIds] = useState(new Set());

  // Input States
  const subjectState = useUndoRedo(""); 
  const makeupState = useUndoRedo("");
  const outfitState = useUndoRedo(""); 
  const hairState = useUndoRedo("");
  const heldItemState = useUndoRedo(""); 
  const poseState = useUndoRedo(""); 
  const lightingState = useUndoRedo(""); 
  const techState = useUndoRedo("");
  const bgState = useUndoRedo("");

  // States for dynamic custom fields
  const [customFields, setCustomFields] = useState({});

  const derivedCameraTech = useRef(""); 
  
  // Confirmed States
  const [confirmedImagePrompt, setConfirmedImagePrompt] = useState("");
  const [confirmedMakeup, setConfirmedMakeup] = useState("");
  const [confirmedOutfit, setConfirmedOutfit] = useState("");
  const [confirmedHairState, setConfirmedHairState] = useState("");
  const [confirmedHeldItem, setConfirmedHeldItem] = useState(""); 
  const [confirmedPose, setConfirmedPose] = useState(""); 
  const [confirmedLighting, setConfirmedLighting] = useState(""); 
  const [confirmedTechFromImage, setConfirmedTechFromImage] = useState("");
  const [confirmedBackground, setConfirmedBackground] = useState("");
  
  // General States
  const [finalPrompt, setFinalPrompt] = useState("");
  const [finalExplanation, setFinalExplanation] = useState(""); 
  const [conflictReport, setConflictReport] = useState(""); 
  const [copied, setCopied] = useState(false);
  
  // Explanations State
  const [explanations, setExplanations] = useState({});

  // Image States
  const [uploadedImage, setUploadedImage] = useState(null);
  const [uploadedImageBase64, setUploadedImageBase64] = useState(null);
  const [uploadedBgImage, setUploadedBgImage] = useState(null);
  const [uploadedBgImageBase64, setUploadedBgImageBase64] = useState(null);
  const [uploadedOutfitImage, setUploadedOutfitImage] = useState(null);
  const [uploadedOutfitImageBase64, setUploadedOutfitImageBase64] = useState(null);
  const [uploadedHairImage, setUploadedHairImage] = useState(null);
  const [uploadedHairImageBase64, setUploadedHairImageBase64] = useState(null);
  const [uploadedTechImage, setUploadedTechImage] = useState(null);
  const [uploadedTechImageBase64, setUploadedTechImageBase64] = useState(null);
  const [uploadedHeldItemImage, setUploadedHeldItemImage] = useState(null);
  const [uploadedHeldItemImageBase64, setUploadedHeldItemImageBase64] = useState(null);
  const [uploadedMakeupImage, setUploadedMakeupImage] = useState(null);
  const [uploadedMakeupImageBase64, setUploadedMakeupImageBase64] = useState(null);
  const [uploadedLightingImage, setUploadedLightingImage] = useState(null); 
  const [uploadedLightingImageBase64, setUploadedLightingImageBase64] = useState(null);
  const [uploadedPoseImage, setUploadedPoseImage] = useState(null);
  const [uploadedPoseImageBase64, setUploadedPoseImageBase64] = useState(null);

  // Analyzing status
  const [isEnriching, setIsEnriching] = useState(false);
  const [isExplainingFinal, setIsExplainingFinal] = useState(false);
  const [isDetectingConflicts, setIsDetectingConflicts] = useState(false);
  const [isAnalyzingImage, setIsAnalyzingImage] = useState(false);
  const [isAnalyzingBg, setIsAnalyzingBg] = useState(false);
  const [isAnalyzingOutfit, setIsAnalyzingOutfit] = useState(false);
  const [isAnalyzingHair, setIsAnalyzingHair] = useState(false);
  const [isAnalyzingTech, setIsAnalyzingTech] = useState(false);
  const [isAnalyzingHeldItem, setIsAnalyzingHeldItem] = useState(false);
  const [isAnalyzingMakeup, setIsAnalyzingMakeup] = useState(false);
  const [isAnalyzingLighting, setIsAnalyzingLighting] = useState(false); 
  const [isAnalyzingPose, setIsAnalyzingPose] = useState(false); 
  const [isGeneratingSurprise, setIsGeneratingSurprise] = useState(false);
  const [isSavingEdit, setIsSavingEdit] = useState(false);
  
  const [suggestionLoading, setSuggestionLoading] = useState(null);
  const [fieldSuggestions, setFieldSuggestions] = useState({}); 
  const [aiData, setAiData] = useState({});

  // Firebase
  const [user, setUser] = useState(null);
  const [history, setHistory] = useState([]);
  const [isSaving, setIsSaving] = useState(false);
  
  // Studio
  const [customCategories, setCustomCategories] = useState({});
  const [customOptions, setCustomOptions] = useState({});
  const [activeData, setActiveData] = useState(PROMPT_DATA);
  const [modalOpen, setModalOpen] = useState(false);
  const [modalType, setModalType] = useState('category');
  const [targetCategory, setTargetCategory] = useState(null);
  const [editingOption, setEditingOption] = useState(null); // Data of option being edited
  const [editModalOpen, setEditModalOpen] = useState(false);

  // Visibility
  const [showBgUpload, setShowBgUpload] = useState(false);
  const [showOutfitUpload, setShowOutfitUpload] = useState(false);
  const [showHairUpload, setShowHairUpload] = useState(false);
  const [showTechUpload, setShowTechUpload] = useState(false);
  const [showHeldItemUpload, setShowHeldItemUpload] = useState(false);
  const [showMakeupUpload, setShowMakeupUpload] = useState(false);
  const [showLightingUpload, setShowLightingUpload] = useState(false); 
  const [showPoseUpload, setShowPoseUpload] = useState(false); 

  const fileInputRef = useRef(null);
  const bgFileInputRef = useRef(null);
  const outfitFileInputRef = useRef(null);
  const hairFileInputRef = useRef(null);
  const techFileInputRef = useRef(null);
  const heldItemFileInputRef = useRef(null);
  const makeupFileInputRef = useRef(null);
  const lightingFileInputRef = useRef(null); 
  const poseFileInputRef = useRef(null); 

  const titleGradientClass = "bg-gradient-to-r from-white via-[#D3A08F] to-white/60 bg-clip-text text-transparent";

  // --- FIREBASE SYNC ---
  useEffect(() => {
    const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const historyRef = collection(db, 'artifacts', appId, 'users', user.uid, 'history');
    const unsubHistory = onSnapshot(historyRef, (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        setHistory(data);
    }, (err) => console.error("History sync error:", err));

    const catUnsub = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'custom_categories'), (snap) => {
        const cats = {}; snap.forEach(doc => cats[doc.id] = { ...doc.data(), isCustom: true });
        setCustomCategories(cats);
    });

    const optUnsub = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'custom_options'), (snap) => {
        const opts = {}; snap.forEach(doc => { const d = doc.data(); if(!opts[d.categoryId]) opts[d.categoryId] = []; opts[d.categoryId].push({ ...d, id: doc.id, isCustom: true }); });
        setCustomOptions(opts);
    });

    return () => { unsubHistory(); catUnsub(); optUnsub(); };
  }, [user]);

  useEffect(() => {
    const merged = { ...PROMPT_DATA };
    Object.keys(merged).forEach(key => {
        merged[key] = { ...merged[key] };
        merged[key].options = [...(merged[key].options || [])];
    });
    Object.keys(merged).forEach(key => {
        if (customOptions[key]) merged[key].options = [...merged[key].options, ...customOptions[key]];
    });
    Object.keys(customCategories).forEach(key => {
        merged[key] = { ...customCategories[key], options: customOptions[key] || [] };
    });
    setActiveData(merged);
  }, [customCategories, customOptions]);

  // --- LOGIC ---
  const handleSelect = useCallback((categoryKey, option) => {
    if (isGlobalEditMode) return; // Disable selection in edit mode
    setSelections(prev => ({ ...prev, [categoryKey]: prev[categoryKey]?.id === option.id ? null : option }));
    if(option.detail_vi) setExplanations(prev => ({...prev, [categoryKey]: String(option.detail_vi || '')}));
  }, [isGlobalEditMode]);

  const recommendedIds = useMemo(() => {
    const ids = new Set();
    Object.values(selections).forEach(sel => {
      if (sel?.recommended && Array.isArray(sel.recommended)) {
        sel.recommended.forEach(id => ids.add(id));
      }
    });
    return ids;
  }, [selections]);

  const toggleExpand = (id, type) => {
      if (type === 'prompt') {
          setExpandedOptionIds(prev => {
              const next = new Set(prev);
              if (next.has(id)) next.delete(id); else next.add(id);
              return next;
          });
      } else {
          setExpandedDetailIds(prev => {
              const next = new Set(prev);
              if (next.has(id)) next.delete(id); else next.add(id);
              return next;
          });
      }
  };

  const getLabelById = (id) => {
      for (const cat of Object.values(activeData)) {
          const found = cat.options?.find(opt => opt.id === id);
          if (found) return found.label;
      }
      return id;
  };

  const combineCameraPrompts = useCallback((angleOpt, lensOpt, techOpt) => {
    let parts = [];
    if (angleOpt?.value) parts.push(String(angleOpt.value));
    if (lensOpt?.value) parts.push(String(lensOpt.value));
    if (techOpt?.value) parts.push(String(techOpt.value)); 
    return parts.join(", ");
  }, []);

  useEffect(() => {
    const combinedTech = combineCameraPrompts(selections.camera_setup, selections.camera, selections.technical);
    derivedCameraTech.current = combinedTech;
    techState.set(combinedTech || ""); 
  }, [selections, combineCameraPrompts]);

  // Generate Final Prompt
  useEffect(() => {
    const coreParts = [
      confirmedImagePrompt, confirmedMakeup, confirmedOutfit, confirmedHairState, confirmedPose,
      confirmedHeldItem, confirmedLighting, confirmedBackground, confirmedTechFromImage
    ];
    
    // Include custom fields in the final prompt
    const customParts = Object.values(customFields).map(f => f.confirmed).filter(Boolean);

    const allParts = [...coreParts, ...customParts];

    const formattedParts = allParts
      .filter(p => typeof p === 'string' && p.trim().length > 0)
      .map(p => { const trimmed = p.trim(); return trimmed.endsWith('.') ? trimmed : trimmed + '.'; });
    setFinalPrompt(formattedParts.join(" "));
  }, [confirmedImagePrompt, confirmedMakeup, confirmedOutfit, confirmedHairState, confirmedHeldItem, confirmedPose, confirmedTechFromImage, confirmedBackground, confirmedLighting, customFields]);

    // Detect Conflicts
  useEffect(() => {
    if (!finalPrompt || finalPrompt.length < 20) { setConflictReport(""); return; }
    const timer = setTimeout(async () => {
        setIsDetectingConflicts(true);
        const checkPrompt = `Check for photo contradictions in: "${finalPrompt}". Return Vietnamese bullets or nothing.`;
        const result = await callGeminiApi({ contents: [{ parts: [{ text: checkPrompt }] }] });
        if (typeof result === 'string' && result.trim().length > 5) setConflictReport(result.trim()); else setConflictReport("");
        setIsDetectingConflicts(false);
    }, 2000); 
    return () => clearTimeout(timer);
  }, [finalPrompt]);

  // --- ACTIONS ---
  const handleAiSuggestions = useCallback(async (fieldKey, currentValue, label) => {
    const val = String(currentValue || '');
    setSuggestionLoading(fieldKey);
    const prompt = `Generate 5 creative photo styles for '${label}'. Context: "${val}". Return JSON array: [{"label_vi": "...", "value_en": "..."}]`;
    const resultText = await callGeminiApi({ contents: [{ parts: [{ text: prompt }] }] });
    if (resultText) {
        try {
            const suggestions = JSON.parse(resultText.replace(/```json/g, '').replace(/```/g, '').trim());
            if (Array.isArray(suggestions)) setFieldSuggestions(prev => ({ ...prev, [fieldKey]: suggestions }));
        } catch (e) { console.error(e); }
    }
    setSuggestionLoading(null);
  }, []);

  const analyzeImageFull = useCallback(async (base64Image) => {
    setIsAnalyzingImage(true);
    const base64Data = base64Image.split(',')[1];
    const promptText = `Analyze image -> JSON keys: subject, makeup, outfit, hair, heldItem, poseHead, poseHands, poseLegs, technical, lighting, background.`;
    const resultText = await callGeminiApi({ contents: [{ parts: [{ text: promptText }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }] });
    if (resultText) {
        try {
            const data = JSON.parse(resultText.replace(/```json/g, '').replace(/```/g, '').trim());
            setAiData(data);
            if(data.subject) subjectState.reset(String(data.subject)); 
            if(data.makeup) makeupState.reset(String(data.makeup)); 
            if(data.outfit) outfitState.reset(String(data.outfit)); 
            if(data.hair) hairState.reset(String(data.hair));
            if(data.heldItem) heldItemState.reset(String(data.heldItem)); 
            const combinedPose = [data.poseHead, data.poseHands, data.poseLegs].filter(p => p && typeof p === 'string').join(", ");
            if(combinedPose) poseState.reset(combinedPose);
            if(data.technical) techState.reset(String(data.technical)); 
            if(data.lighting) lightingState.reset(String(data.lighting));
            if(data.background) bgState.reset(String(data.background));
        } catch(e) {}
    }
    setIsAnalyzingImage(false);
  }, []);

  const analyzeSpecific = useCallback(async (base64Image, promptSuffix, setFunction, setAnalyzing, categoryKey) => {
    setAnalyzing(true);
    if (!base64Image) return;
    const base64Data = base64Image.split(',')[1];
    const promptText = `Analyze ${promptSuffix}. Return JSON: { "description": "English", "explanation": "Vietnamese" }.`;
    const result = await callGeminiApi({ contents: [{ parts: [{ text: promptText }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }] });
    if (typeof result === 'string') {
        try {
            const data = JSON.parse(result.replace(/```json/g, '').replace(/```/g, '').trim());
            setFunction(String(data.description));
            if (categoryKey) {
                setExplanations(prev => ({...prev, [categoryKey]: String(data.explanation)}));
            }
        } catch (e) { setFunction(result.trim()); }
    }
    setAnalyzing(false);
  }, []);

  const handleImageUpload = useCallback(async (event, setImg, setBase64) => {
    const file = event.target.files?.[0];
    if (file) {
        setImg(null); setBase64(null);
        try { const resizedBase64 = await resizeImage(file); setBase64(resizedBase64); setImg(resizedBase64); } catch (e) { console.error(e); }
    }
  }, []);

  const handleExplain = async (key, text) => {
    if (!text || typeof text !== 'string') return;
    setSuggestionLoading(key + '_explain');
    const prompt = `Translate to Vietnamese & Explain vibe in extreme brevity (under 15 words). No fluff: "${text}"`;
    const result = await callGeminiApi({ contents: [{ parts: [{ text: prompt }] }] });
    if (typeof result === 'string') setExplanations(prev => ({...prev, [key]: result.trim()}));
    setSuggestionLoading(null);
  };

  const handleExplainFinal = async () => {
      if (!finalPrompt || typeof finalPrompt !== 'string') return;
      setIsExplainingFinal(true);
      const prompt = `Translate & Explain vibe of: "${finalPrompt}" in Vietnamese (2 sentences).`;
      const result = await callGeminiApi({ contents: [{ parts: [{ text: prompt }] }] });
      if (typeof result === 'string') setFinalExplanation(result.trim());
      setIsExplainingFinal(false);
  };

  const handleAnalyzePrompt = async (promptText) => {
    if (!promptText) return;
    setIsEnriching(true);
    const prompt = `Analyze prompt -> JSON keys: subject, makeup, outfit, hair, heldItem, poseHead, poseHands, poseLegs, technical, lighting, background. Return ONLY valid JSON. Prompt: "${promptText}"`;
    
    try {
        const resultText = await callGeminiApi({ contents: [{ parts: [{ text: prompt }] }] });
        if (resultText) {
            const data = JSON.parse(resultText.replace(/```json/g, '').replace(/```/g, '').trim());
            setAiData(data); // Highlight AI suggestions
            
            // Auto-fill states
            if(data.subject) { subjectState.reset(String(data.subject)); setConfirmedImagePrompt(String(data.subject)); }
            if(data.makeup) { makeupState.reset(String(data.makeup)); setConfirmedMakeup(String(data.makeup)); }
            if(data.outfit) { outfitState.reset(String(data.outfit)); setConfirmedOutfit(String(data.outfit)); }
            if(data.hair) { hairState.reset(String(data.hair)); setConfirmedHairState(String(data.hair)); }
            if(data.heldItem) { heldItemState.reset(String(data.heldItem)); setConfirmedHeldItem(String(data.heldItem)); }
            
            const combinedPose = [data.poseHead, data.poseHands, data.poseLegs].filter(p => p && typeof p === 'string').join(", ");
            if(combinedPose) { poseState.reset(combinedPose); setConfirmedPose(combinedPose); }
            
            if(data.technical) { techState.reset(String(data.technical)); setConfirmedTechFromImage(String(data.technical)); }
            if(data.lighting) { lightingState.reset(String(data.lighting)); setConfirmedLighting(String(data.lighting)); }
            if(data.background) { bgState.reset(String(data.background)); setConfirmedBackground(String(data.background)); }
        }
    } catch (e) {
        console.error("Error analyzing prompt:", e);
    }
    setIsEnriching(false);
  };

  const handleSurpriseMe = async () => {
    setIsGeneratingSurprise(true);
    const promptText = `Generate creative photo concept JSON: subject, makeup, outfit, hair, heldItem, poseHead, poseHands, poseLegs, background, technical, lighting.`;
    try {
        const result = await callGeminiApi({ contents: [{ parts: [{ text: promptText }] }] });
        if (result) {
            const data = JSON.parse(result.replace(/```json/g, '').replace(/```/g, '').trim());
            setAiData(data);
            if (data.subject) { subjectState.reset(String(data.subject)); setConfirmedImagePrompt(String(data.subject)); }
            if (data.makeup) { makeupState.reset(String(data.makeup)); setConfirmedMakeup(String(data.makeup)); }
            if (data.outfit) { outfitState.reset(String(data.outfit)); setConfirmedOutfit(String(data.outfit)); }
            if (data.hair) { hairState.reset(String(data.hair)); setConfirmedHairState(String(data.hair)); }
            if (data.background) { bgState.reset(String(data.background)); setConfirmedBackground(String(data.background)); }
            if (data.technical) { techState.reset(String(data.technical)); setConfirmedTechFromImage(String(data.technical)); }
            if (data.lighting) { lightingState.reset(String(data.lighting)); setConfirmedLighting(String(data.lighting)); }
        }
    } catch (e) { console.error(e); }
    setIsGeneratingSurprise(false);
  };

  const handleSavePrompt = async () => {
    if (!user || !finalPrompt) return;
    setIsSaving(true);
    try {
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), {
            prompt: finalPrompt,
            explanation: String(finalExplanation || ""),
            createdAt: new Date(),
            subject: String(confirmedImagePrompt || ""),
        });
    } catch (e) { console.error(e); }
    setIsSaving(false);
  };

  const handleDeleteHistory = async (id) => {
      if (!user) return;
      try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'history', id)); } catch (e) { console.error(e); }
  }

  const loadFromHistory = (item) => {
    if (item.prompt) setFinalPrompt(String(item.prompt));
    if (item.explanation) setFinalExplanation(String(item.explanation));
    if (item.subject) { subjectState.reset(String(item.subject)); setConfirmedImagePrompt(String(item.subject)); }
  };

  // --- EDIT OPTION LOGIC ---
  const handleEditOption = (option, categoryId) => {
    setEditingOption({ ...option, categoryId });
    setEditModalOpen(true);
  };

  const handleSaveEdit = async (newData) => {
    if (!user || !editingOption) return;
    setIsSavingEdit(true);

    let finalValue = newData.value;
    // Check if prompt value changed, if so, use AI to refine
    if (newData.value !== editingOption.value && newData.value.length > 5) {
        const refinePrompt = `Refine this image prompt to be more detailed and better for AI generation. Keep it under 30 words. Prompt: "${newData.value}"`;
        const enriched = await callGeminiApi({ contents: [{ parts: [{ text: refinePrompt }] }] });
        if (enriched) finalValue = enriched.trim();
    }

    const dataToSave = {
        label: newData.label,
        subLabel: newData.subLabel,
        value: finalValue,
        detail_vi: newData.detail_vi,
        img: newData.img,
        categoryId: editingOption.categoryId
    };

    try {
        if (editingOption.isCustom) {
            // Update existing custom option
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'custom_options', editingOption.id), dataToSave);
        } else {
            // Create new custom option from static one (effectively overriding or adding a copy)
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'custom_options'), dataToSave);
        }
        setEditModalOpen(false);
        setEditingOption(null);
    } catch (e) {
        console.error("Error saving edit:", e);
    }
    setIsSavingEdit(false);
  };

  const allCategoryKeys = useMemo(() => [...CATEGORY_ORDER, ...Object.keys(customCategories)], [customCategories]);

  // --- DYNAMIC WORKFLOW FIELD GENERATION ---
  const workflowFields = useMemo(() => {
    // 1. Subject (Always present and first)
    const fields = [
      { 
        id: 'subject', label: "1. " + (isProductMode ? "Sản phẩm" : "Chủ thể"), icon: ImageIcon, 
        state: subjectState, setConf: setConfirmedImagePrompt, conf: confirmedImagePrompt, 
        key: 'subject', explKey: 'subject', selection: null, promptSuffix: 'subject description' 
      }
    ];

    // 2. Iterate through ordered categories
    let indexCounter = 2;

    allCategoryKeys.forEach(key => {
        // Skip hidden categories in product mode
        if (isProductMode && ['accessories', 'makeup', 'hair', 'pose_head', 'pose_hands', 'pose_legs'].includes(key)) return;
        if (key === 'camera_setup') return; // Skip camera setup as it merges into 'tech' or is handled separately

        const catData = activeData[key];
        const label = `${indexCounter}. ${catData?.title || key}`;
        
        let fieldConfig = {
            id: key,
            label: label,
            icon: catData?.icon || Sparkles,
            key: key,
            explKey: key,
        };

        // Specific configurations for core fields
        if (key === 'camera' || key === 'technical') {
            // Merge camera/technical logic
             if (key === 'camera') return; // Skip camera, handle in technical/tech
             if (key === 'technical') {
                 fieldConfig = {
                    ...fieldConfig,
                    id: 'tech',
                    label: `${indexCounter}. Camera & Lens`,
                    icon: Aperture,
                    state: techState,
                    setConf: setConfirmedTechFromImage,
                    conf: confirmedTechFromImage,
                    explKey: 'technical',
                    ref: techFileInputRef,
                    uploadImg: uploadedTechImage,
                    setUpload: setUploadedTechImage,
                    setBase64: setUploadedTechImageBase64,
                    analyzing: isAnalyzingTech,
                    setAnalyzing: setIsAnalyzingTech,
                    promptSuffix: "camera settings",
                    selection: derivedCameraTech.current,
                    showUpload: showTechUpload,
                    setShowUpload: setShowTechUpload,
                    uploadBase64: uploadedTechImageBase64
                 };
             }
        } else if (key === 'lighting') {
             fieldConfig = {
                ...fieldConfig,
                state: lightingState,
                setConf: setConfirmedLighting,
                conf: confirmedLighting,
                ref: lightingFileInputRef,
                uploadImg: uploadedLightingImage,
                setUpload: setUploadedLightingImage,
                setBase64: setUploadedLightingImageBase64,
                analyzing: isAnalyzingLighting,
                setAnalyzing: setIsAnalyzingLighting,
                promptSuffix: "lighting style",
                selection: selections.lighting?.value,
                showUpload: showLightingUpload,
                setShowUpload: setShowLightingUpload,
                uploadBase64: uploadedLightingImageBase64
             };
        } else if (key === 'makeup') {
             fieldConfig = { ...fieldConfig, state: makeupState, setConf: setConfirmedMakeup, conf: confirmedMakeup, ref: makeupFileInputRef, uploadImg: uploadedMakeupImage, setUpload: setUploadedMakeupImage, setBase64: setUploadedMakeupImageBase64, analyzing: isAnalyzingMakeup, setAnalyzing: setIsAnalyzingMakeup, promptSuffix: "makeup style", selection: selections.makeup?.value, showUpload: showMakeupUpload, setShowUpload: setShowMakeupUpload, uploadBase64: uploadedMakeupImageBase64 };
        } else if (key === 'hair') {
             fieldConfig = { ...fieldConfig, state: hairState, setConf: setConfirmedHairState, conf: confirmedHairState, ref: hairFileInputRef, uploadImg: uploadedHairImage, setUpload: setUploadedHairImage, setBase64: setUploadedHairImageBase64, analyzing: isAnalyzingHair, setAnalyzing: setIsAnalyzingHair, promptSuffix: "hair style", selection: selections.hair?.value, showUpload: showHairUpload, setShowUpload: setShowHairUpload, uploadBase64: uploadedHairImageBase64 };
        } else if (key === 'outfit') {
             fieldConfig = { ...fieldConfig, state: outfitState, setConf: setConfirmedOutfit, conf: confirmedOutfit, ref: outfitFileInputRef, uploadImg: uploadedOutfitImage, setUpload: setUploadedOutfitImage, setBase64: setUploadedOutfitImageBase64, analyzing: isAnalyzingOutfit, setAnalyzing: setIsAnalyzingOutfit, promptSuffix: "outfit style", selection: selections.outfit?.value, showUpload: showOutfitUpload, setShowUpload: setShowOutfitUpload, uploadBase64: uploadedOutfitImageBase64 };
        } else if (['pose_head', 'pose_hands', 'pose_legs'].includes(key)) {
             if (key !== 'pose_legs') return; // Only add one "Pose" field
             fieldConfig = { ...fieldConfig, id: 'pose', label: `${indexCounter}. Dáng & Cử chỉ`, icon: User, state: poseState, setConf: setConfirmedPose, conf: confirmedPose, ref: poseFileInputRef, uploadImg: uploadedPoseImage, setUpload: setUploadedPoseImage, setBase64: setUploadedPoseImageBase64, analyzing: isAnalyzingPose, setAnalyzing: setIsAnalyzingPose, promptSuffix: "pose description", selection: null, showUpload: showPoseUpload, setShowUpload: setShowPoseUpload, uploadBase64: uploadedPoseImageBase64 };
        } else if (key === 'accessories') {
             fieldConfig = { ...fieldConfig, id: 'heldItem', label: `${indexCounter}. Phụ kiện & Đồ cầm`, icon: ShoppingBag, state: heldItemState, setConf: setConfirmedHeldItem, conf: confirmedHeldItem, ref: heldItemFileInputRef, uploadImg: uploadedHeldItemImage, setUpload: setUploadedHeldItemImage, setBase64: setUploadedHeldItemImageBase64, analyzing: isAnalyzingHeldItem, setAnalyzing: setIsAnalyzingHeldItem, promptSuffix: "held items", selection: selections.accessories?.value, showUpload: showHeldItemUpload, setShowUpload: setShowHeldItemUpload, uploadBase64: uploadedHeldItemImageBase64 };
        } else if (key === 'bg') { 
             return; 
        } else {
             fieldConfig = {
                 ...fieldConfig,
                 isCustom: true,
                 selection: selections[key]?.value
             };
        }
        
        fields.push(fieldConfig);
        indexCounter++;
    });
    
    // Always add Background at the end if not present
    fields.push({
        id: 'bg', label: `${indexCounter}. Bối cảnh`, icon: MapPin, 
        state: bgState, setConf: setConfirmedBackground, conf: confirmedBackground, 
        key: 'background', explKey: 'background', 
        ref: bgFileInputRef, uploadImg: uploadedBgImage, setUpload: setUploadedBgImage, setBase64: setUploadedBgImageBase64, 
        analyzing: isAnalyzingBg, setAnalyzing: setIsAnalyzingBg, promptSuffix: "background description", selection: null,
        showUpload: showBgUpload, setShowUpload: setShowBgUpload, uploadBase64: uploadedBgImageBase64
    });

    return fields;
  }, [
    activeData, allCategoryKeys, isProductMode, selections, aiData,
    subjectState, techState, lightingState, makeupState, hairState, outfitState, poseState, heldItemState, bgState,
    confirmedImagePrompt, confirmedTechFromImage, confirmedLighting, confirmedMakeup, confirmedHairState, confirmedOutfit, confirmedPose, confirmedHeldItem, confirmedBackground,
    uploadedTechImage, uploadedLightingImage, uploadedMakeupImage, uploadedHairImage, uploadedOutfitImage, uploadedPoseImage, uploadedHeldItemImage, uploadedBgImage,
    isAnalyzingTech, isAnalyzingLighting, isAnalyzingMakeup, isAnalyzingHair, isAnalyzingOutfit, isAnalyzingPose, isAnalyzingHeldItem, isAnalyzingBg,
    showTechUpload, showLightingUpload, showMakeupUpload, showHairUpload, showOutfitUpload, showPoseUpload, showHeldItemUpload, showBgUpload
  ]);


  return (
    <div className="min-h-[100dvh] bg-[#0a0504] text-[#D3A08F] font-sans pb-8">
      <BackgroundLiquid />
      <GlobalGradientDef />
      <CustomCreatorModal 
        isOpen={modalOpen} 
        onClose={() => setModalOpen(false)} 
        type={modalType} 
        parentCategory={activeData[targetCategory]?.title} 
        onSave={(data) => {
            if (modalType === 'category') {
                const id = data.id || `cat_${Date.now()}`;
                setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'custom_categories', id), data);
            } else {
                addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'custom_options'), { ...data, categoryId: targetCategory });
            }
        }} 
      />
      <EditOptionModal 
        isOpen={editModalOpen} 
        onClose={() => setEditModalOpen(false)} 
        optionData={editingOption} 
        onSave={handleSaveEdit} 
        isProcessing={isSavingEdit} 
      />

      <header className="border-b border-white/5 bg-transparent relative z-50 h-16 md:h-20 flex items-center">
        <div className="max-w-[1400px] w-full mx-auto px-4 md:px-6 flex items-center justify-between">
          <div className="flex items-center gap-3 md:gap-4">
            <div className="bg-[#FE9C00] p-2 md:p-2.5 rounded-[1rem] shadow-lg shadow-[#FE9C00]/20"><Sparkles size={22} className="text-white" /></div>
            <div>
              <h1 className="text-xl md:text-2xl font-black tracking-tight bg-gradient-to-r from-white via-[#D3A08F] to-white/60 bg-clip-text text-transparent uppercase">Prompt Builder</h1>
              <p className="text-[9px] font-bold text-[#8F8D8D]/50 uppercase tracking-widest mt-1">THE CRABIC AI</p>
            </div>
          </div>
          <div className="flex gap-2">
            <button onClick={handleSurpriseMe} disabled={isGeneratingSurprise} className="hidden md:flex items-center gap-2 bg-[#FE9C00]/20 px-4 py-2 rounded-[0.8rem] transition-all">
                {isGeneratingSurprise ? <Loader2 size={16} className="animate-spin text-[#FE9C00]" /> : <Lightbulb size={16} className="text-[#FE9C00]" />}
                <span className="text-xs font-bold text-[#FE9C00]">Inspire Me</span>
            </button>
            <button onClick={() => window.location.reload()} className="p-2 bg-white/5 border border-[#FE9C00]/20 rounded-[0.8rem] transition-all">
              <RefreshCw size={16} className="text-[#FE9C00]" />
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-[1400px] mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-10">
        {/* Left Side: Category Library */}
        <div className="lg:col-span-7 space-y-4">
          <div className="flex gap-4 mb-6">
              <ModeToggle isProduct={isProductMode} onToggle={setIsProductMode} />
              
              {/* Global Edit Mode Toggle */}
              <button 
                  onClick={() => setIsGlobalEditMode(!isGlobalEditMode)} 
                  className={`px-6 rounded-2xl border transition-all duration-300 flex items-center justify-center gap-2 ${isGlobalEditMode ? 'bg-red-500/10 border-red-500/30 text-red-400' : 'bg-white/5 border-white/10 text-white/40 hover:text-white hover:bg-white/10'}`}
                  title="Chế độ Chỉnh sửa"
              >
                  <Edit3 size={18} />
                  <span className="text-sm font-black uppercase hidden sm:inline">{isGlobalEditMode ? "Đang Sửa" : "Sửa"}</span>
              </button>
          </div>

          <div className="flex items-center justify-between px-2 mb-2">
             <span className="text-xs font-black uppercase tracking-widest text-white/40">Thư viện Lựa chọn</span>
             {isGlobalEditMode && (
                 <button onClick={() => { setModalType('category'); setModalOpen(true); }} className="text-[10px] font-bold bg-[#FE9C00]/20 text-[#FE9C00] px-3 py-1.5 rounded-full hover:bg-[#FE9C00] hover:text-white transition-all animate-in fade-in">
                     <Plus size={12} className="inline mr-1" /> Thêm Danh mục
                 </button>
             )}
          </div>

          {allCategoryKeys.map((key) => {
            const category = activeData[key];
            if (!category) return null;
            if (isProductMode && ['accessories', 'makeup', 'hair', 'pose_head', 'pose_hands', 'pose_legs'].includes(key)) return null;
            const isOpen = activeCategory === key;
            
            return (
              <div key={key} className={`rounded-[2rem] overflow-hidden transition-all duration-500 gradient-border shadow-2xl ${isOpen ? 'bg-black/30 backdrop-blur-3xl' : 'hover:bg-white/5'}`}>
                <button onClick={() => setActiveCategory(isOpen ? "" : key)} className="w-full p-5 md:p-6 flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className={`w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center transition-all ${isOpen ? 'bg-[#FE9C00]' : 'bg-white/5'}`}>
                       <GradientIcon icon={category.icon} iconName={typeof category.icon === 'string' ? category.icon : undefined} size={22} className={isOpen ? "text-white" : ""} />
                    </div>
                    <div className="text-left">
                      <h3 className={`font-black text-lg md:text-xl tracking-tight ${titleGradientClass} flex items-center gap-2 uppercase`}>
                          {String(category.title || '')}
                          {category.isCustom && <span className="text-[9px] bg-[#FE9C00] text-white px-1.5 rounded uppercase font-bold tracking-wider">Custom</span>}
                      </h3>
                      <p className="text-xs font-medium text-white/80">{String(category.description || '')}</p>
                    </div>
                  </div>
                  <ChevronDown size={20} className={`transition-transform duration-500 ${isOpen ? 'rotate-180' : ''}`} />
                </button>
                {isOpen && (
                  <div className="p-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {/* Render Options FIRST */}
                    {category.options?.map((option) => {
                      const isSelected = selections[key]?.id === option.id;
                      const isRecommended = !isSelected && recommendedIds.has(option.id);
                      const isPromptExpanded = expandedOptionIds.has(option.id);
                      const isDetailExpanded = expandedDetailIds.has(option.id);

                      return (
                        <div 
                          key={option.id} 
                          className={`group relative rounded-[1.8rem] border overflow-hidden transition-all duration-300 flex flex-col 
                            ${isSelected && !isGlobalEditMode
                                ? 'bg-[#FE9C00]/15 border-[#FE9C00]/60 shadow-lg' 
                                : isRecommended && !isGlobalEditMode
                                    ? 'bg-[#FE9C00]/5 border-[#FE9C00]/50 shadow-[0_0_15px_rgba(254,156,0,0.15)] ring-1 ring-[#FE9C00]/30 animate-pulse'
                                    : 'bg-white/[0.03] border-white/5 hover:border-white/20'
                            }`} 
                          onClick={() => handleSelect(key, option)}
                        >
                          <div className={`flex items-center gap-4 p-4 ${isGlobalEditMode ? '' : 'cursor-pointer'} relative z-10`}>
                            {/* Image Section with Overlay Tick */}
                            <div className="relative">
                                <img src={String(option.img || '')} className={`w-16 h-16 rounded-2xl object-cover ring-2 transition-all ${isSelected && !isGlobalEditMode ? 'ring-[#FE9C00]' : 'ring-white/10 group-hover:ring-white/30'}`} alt="" />
                                {isSelected && !isGlobalEditMode && (
                                    <div className="absolute inset-0 flex items-center justify-center bg-black/40 rounded-2xl backdrop-blur-[1px]">
                                        <Check size={24} className="text-[#FE9C00] drop-shadow-lg" strokeWidth={4} />
                                    </div>
                                )}
                            </div>

                            <div className="flex-1 min-w-0">
                                <div className="flex items-center justify-between gap-2">
                                    <h4 className={`text-sm md:text-base font-black truncate ${isSelected && !isGlobalEditMode ? 'text-[#FE9C00]' : 'text-white'}`}>{String(option.label || '')}</h4>
                                </div>
                                <p className="text-[10px] font-bold text-white/40 uppercase tracking-wider">{String(option.subLabel || '')}</p>
                                {isRecommended && !isGlobalEditMode && <span className="text-[9px] text-[#FE9C00] font-bold uppercase mt-1 inline-block animate-pulse">✨ Recommended</span>}
                            </div>
                            
                            {/* Action Buttons (Vertical) */}
                            <div className="flex flex-col gap-2">
                                 {isGlobalEditMode ? (
                                     <button 
                                        onClick={(e) => { e.stopPropagation(); handleEditOption(option, key); }} 
                                        className={`p-3 rounded-xl transition-all bg-[#FE9C00] text-white shadow-lg shadow-[#FE9C00]/20 hover:bg-[#FE9C00]/80`}
                                        title="Chỉnh sửa Lựa chọn"
                                     >
                                         <Edit3 size={18} />
                                     </button>
                                 ) : (
                                     <>
                                         <button 
                                            onClick={(e) => { e.stopPropagation(); toggleExpand(option.id, 'prompt'); }} 
                                            className={`p-2 rounded-xl transition-all ${isPromptExpanded ? 'bg-[#FE9C00] text-white shadow-lg shadow-[#FE9C00]/20' : 'bg-white/5 text-white/40 hover:bg-white/10 hover:text-white border border-white/5'}`}
                                            title="Xem Prompt (Raw)"
                                         >
                                             <Eye size={14} />
                                         </button>
                                         <button 
                                            onClick={(e) => { e.stopPropagation(); toggleExpand(option.id, 'detail'); }} 
                                            className={`p-2 rounded-xl transition-all ${isDetailExpanded ? 'bg-[#FE9C00] text-white shadow-lg shadow-[#FE9C00]/20' : 'bg-white/5 text-white/40 hover:bg-white/10 hover:text-white border border-white/5'}`}
                                            title="Xem Chi tiết"
                                         >
                                             <BookOpenCheck size={14} />
                                         </button>
                                     </>
                                 )}
                            </div>
                          </div>
                          
                          {/* Expanded Content (Only show if NOT in Edit Mode) */}
                          {!isGlobalEditMode && (isPromptExpanded || isDetailExpanded) && (
                              <div className="px-4 pb-4 animate-in slide-in-from-top-2 duration-300">
                                  <div className="bg-black/40 rounded-xl p-3 border border-white/5 space-y-2">
                                      {isPromptExpanded && (
                                          <div>
                                              <span className="text-[9px] uppercase font-bold text-[#FE9C00] block mb-1">Raw Prompt:</span>
                                              <p className="text-xs text-white/80 font-mono bg-black/30 p-2 rounded-lg break-words">{String(option.value || '')}</p>
                                          </div>
                                      )}
                                      {isDetailExpanded && (
                                          <div>
                                              <span className="text-[9px] uppercase font-bold text-[#FE9C00] block mb-1">Diễn giải Chi tiết:</span>
                                              <p className="text-xs text-white/70 italic leading-relaxed">{String(option.detail_vi || 'Chưa có thông tin chi tiết.')}</p>
                                          </div>
                                      )}
                                  </div>
                              </div>
                          )}
                        </div>
                      );
                    })}
                    
                    {/* Add Option Button (Only visible in Edit Mode) */}
                    {isGlobalEditMode && (
                        <button onClick={() => { setTargetCategory(key); setModalType('option'); setModalOpen(true); }} className="h-24 rounded-[1.8rem] border border-dashed border-white/20 hover:border-[#FE9C00] flex flex-col items-center justify-center gap-2 transition-all group animate-in fade-in">
                            <Plus size={18} className="group-hover:text-[#FE9C00]" />
                            <span className="text-[10px] font-bold uppercase text-white/40 group-hover:text-[#FE9C00]">Thêm Lựa chọn</span>
                        </button>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>

        {/* Right Side: Workflow Output */}
        <div className="lg:col-span-5 flex flex-col gap-6 lg:sticky lg:top-24 h-fit">
          <div className="bg-transparent backdrop-blur-[60px] border border-white/10 rounded-[2.5rem] overflow-hidden shadow-2xl p-2 gradient-border">
            <div className="p-5 flex items-center gap-4 border-b border-white/5">
                <div className="p-2.5 bg-[#FE9C00] rounded-xl"><Terminal size={22} className="text-white" /></div>
                <span className="text-lg font-black tracking-tight text-white uppercase">Workflow</span>
            </div>
            
            <div className="p-4 md:p-6 space-y-6 lg:max-h-[75vh] lg:overflow-y-auto custom-scrollbar">
              
              {/* Main Image Analyzer */}
              <div className="p-4 bg-black/30 rounded-[1.8rem] border border-white/5 flex flex-col gap-4 shadow-inner">
                {uploadedImage ? (
                  <div className="w-full relative rounded-[1.5rem] overflow-hidden h-48 ring-2 ring-white/10 shadow-xl">
                    <img src={uploadedImage} alt="Preview" className="w-full h-full object-cover" />
                    <button onClick={() => {setUploadedImage(null); setUploadedImageBase64(null);}} className="absolute top-4 right-4 bg-black/70 p-2 rounded-full"><X size={18} className="text-white" /></button>
                  </div>
                ) : (
                  <div onClick={() => fileInputRef.current?.click()} className="w-full h-40 border-2 border-dashed border-white/10 rounded-[1.5rem] bg-black/30 flex flex-col items-center justify-center cursor-pointer hover:border-[#FE9C00]/50 transition-all group">
                    <Upload size={32} className="text-slate-300 group-hover:text-[#FE9C00]" />
                    <span className="mt-3 text-sm font-black text-slate-200 uppercase">Phân tích ảnh chính</span>
                  </div>
                )}
                <input type="file" ref={fileInputRef} onChange={(e) => handleImageUpload(e, setUploadedImage, setUploadedImageBase64)} accept="image/*" className="hidden" />
                <button onClick={() => uploadedImageBase64 && analyzeImageFull(uploadedImageBase64)} disabled={!uploadedImageBase64 || isAnalyzingImage} className={`w-full py-4 flex items-center justify-center gap-4 text-base font-black uppercase rounded-[1.2rem] transition-all shadow-xl active:scale-95 ${!uploadedImageBase64 ? 'bg-white/5 text-slate-700' : 'bg-[#FE9C00] text-white shadow-[#FE9C00]/40 ring-1 ring-white/20'}`}>
                  {isAnalyzingImage ? <Loader2 size={22} className="animate-spin text-white" /> : <ScanEye size={22} className="text-white" />} 
                  <span className="text-white">{isAnalyzingImage ? "Đang quét..." : "Phân tích AI"}</span>
                </button>
              </div>

              {/* Dynamic Workflow Fields */}
              {workflowFields.map(f => (
                <WorkflowItem 
                    key={f.id}
                    f={f}
                    customFields={customFields}
                    setCustomFields={setCustomFields}
                    aiData={aiData}
                    explanations={explanations}
                    suggestionLoading={suggestionLoading}
                    fieldSuggestions={fieldSuggestions}
                    handleImageUpload={handleImageUpload}
                    analyzeSpecific={analyzeSpecific}
                    handleExplain={handleExplain}
                    handleAiSuggestions={handleAiSuggestions}
                    titleGradientClass={titleGradientClass}
                />
              ))}

              {/* Final Prompt Result */}
              <div className="pt-8 border-t border-white/5 space-y-4">
                <div className="flex items-center gap-3 mb-2"><Check size={20} className="text-[#FE9C00]" strokeWidth={4} /><span className="text-lg font-black text-white uppercase">Prompt Cuối</span></div>
                
                {conflictReport && (
                    <div className="mb-4 p-4 bg-red-500/10 border border-red-500/30 rounded-2xl animate-in slide-in-from-top-2 duration-500">
                        <div className="flex items-center gap-2 text-red-400 font-black text-xs uppercase mb-1"><ShieldAlert size={14} /> ⚡ Phát hiện xung đột (Conflict Detected)</div>
                        <p className="text-xs text-red-200/80 italic">{String(conflictReport)}</p>
                    </div>
                )}
                {isDetectingConflicts && <div className="mb-4 flex items-center gap-2 px-2 text-[10px] font-bold text-white/40 uppercase animate-pulse"><Loader2 size={10} className="animate-spin" /> Kiểm tra xung đột logic...</div>}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="flex flex-col gap-2">
                         <span className="text-xs font-bold text-white/60 uppercase tracking-widest pl-1">English Prompt</span>
                         <textarea value={finalPrompt} readOnly className="w-full h-48 md:h-64 bg-transparent border border-[#FE9C00]/20 rounded-[2rem] p-6 text-base text-[#D3A08F] font-black leading-relaxed resize-none shadow-2xl backdrop-blur-3xl outline-none" />
                    </div>
                    <div className="flex flex-col gap-2">
                         <span className="text-xs font-bold text-[#FE9C00] uppercase tracking-widest pl-1 flex items-center gap-2"><Languages size={12} /> Diễn giải Tiếng Việt</span>
                         <div className="w-full h-48 md:h-64 bg-white/5 border border-white/10 rounded-[2rem] p-6 text-sm text-white/80 leading-relaxed overflow-y-auto italic custom-scrollbar">
                           {finalExplanation ? String(finalExplanation) : "Nội dung dịch và giải thích sẽ xuất hiện tại đây sau khi bạn bấm nút Diễn giải..."}
                         </div>
                    </div>
                </div>

                <div className="flex flex-col gap-3">
                    <div className="flex flex-row gap-2">
                        <button onClick={handleExplainFinal} disabled={isExplainingFinal || !finalPrompt} className="flex-1 flex items-center justify-center gap-2 px-3 py-4 rounded-[1.2rem] text-sm font-black bg-white/10 border border-[#FE9C00]/30 hover:bg-[#FE9C00]/20 transition-all text-[#FE9C00]">
                            {isExplainingFinal ? <Loader2 size={16} className="animate-spin" /> : <Languages size={16} />} <span className="whitespace-nowrap">Diễn giải</span>
                        </button>
                        <button onClick={handleSavePrompt} disabled={isSaving || !finalPrompt} className="flex-1 flex items-center justify-center gap-2 px-3 py-4 rounded-[1.2rem] text-sm font-black bg-white/10 border border-[#FE9C00]/30 hover:bg-[#FE9C00]/20 transition-all text-[#FE9C00]">
                            {isSaving ? <Loader2 size={16} className="animate-spin" /> : <Bookmark size={16} />} <span className="whitespace-nowrap">Lưu Prompt</span>
                        </button>
                    </div>
                    <button onClick={() => { navigator.clipboard.writeText(finalPrompt); setCopied(true); setTimeout(()=>setCopied(false), 2000); }} className={`w-full py-4 flex items-center justify-center gap-2 rounded-[1.2rem] font-black uppercase text-sm transition-all ${copied ? 'bg-white text-[#FE9C00]' : 'bg-[#FE9C00] text-white shadow-xl shadow-[#FE9C00]/20'}`}>
                        {copied ? <Check size={18} /> : <Copy size={18} />} <span>{copied ? "Đã chép" : "Copy Prompt"}</span>
                    </button>
                </div>

                {/* History */}
                {history.length > 0 && (
                    <div className="pt-6 border-t border-white/5 mt-4">
                        <button 
                            className="w-full flex items-center justify-between gap-2 text-white/60 hover:text-[#FE9C00] transition-colors mb-4 group"
                            onClick={() => setIsHistoryExpanded(!isHistoryExpanded)}
                        >
                             <div className="flex items-center gap-2 font-black text-xs uppercase tracking-widest px-2">
                                <History size={14} /> Lịch sử đã lưu ({history.length})
                             </div>
                             {isHistoryExpanded ? <ChevronUp size={16} className="group-hover:translate-y-[-2px] transition-transform" /> : <ChevronDown size={16} className="group-hover:translate-y-[2px] transition-transform" />}
                        </button>
                        
                        {isHistoryExpanded && (
                            <div className="grid gap-3 max-h-[400px] overflow-y-auto custom-scrollbar pr-2 animate-in slide-in-from-top-2 duration-300">
                                {history.slice(0, 10).map((item) => (
                                    <div key={item.id} className="group relative p-4 rounded-2xl bg-white/[0.02] border border-white/5 hover:border-[#FE9C00]/30 hover:bg-white/[0.04] transition-all">
                                        <p className="text-xs text-white/90 line-clamp-2 mb-2 leading-relaxed font-bold">{String(item.prompt || '')}</p>
                                        <div className="flex items-center justify-between mt-2 pt-2 border-t border-white/5">
                                            <span className="text-[9px] text-white/30 uppercase font-bold tracking-wider">{item.createdAt?.seconds ? new Date(item.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'Just now'}</span>
                                            <div className="flex gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); handleAnalyzePrompt(item.prompt); }} disabled={isEnriching} className="flex items-center gap-1.5 p-1.5 px-3 bg-[#FE9C00]/10 hover:bg-[#FE9C00]/20 rounded-lg text-[#FE9C00] transition-all text-[10px] font-bold uppercase" title="Phân tích & Áp dụng lại">
                                                    {isEnriching ? <Loader2 size={12} className="animate-spin" /> : <ScanEye size={12} />} Phân tích & Áp dụng
                                                </button>
                                                <button onClick={(e) => { e.stopPropagation(); loadFromHistory(item); }} className="p-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-white/60 hover:text-white transition-all" title="Nạp lại vào ô kết quả"><RefreshCw size={12} /></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteHistory(item.id); }} className="p-1.5 bg-red-500/10 hover:bg-red-500/20 rounded-lg text-red-400 transition-all" title="Xóa"><Trash2 size={12} /></button>
                                            </div>
                                        </div>
                                        {item.subject && <div className="absolute top-2 right-2 w-1.5 h-1.5 rounded-full bg-[#FE9C00]/50" />}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(254, 156, 0, 0.2); border-radius: 10px; }
        .gradient-border { position: relative; }
        .gradient-border::after { content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1px; background: linear-gradient(to right, white, #D3A08F, rgba(255,255,255,0.4)); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; pointer-events: none; opacity: 0.15; }
      `}} />
    </div>
  );
}
